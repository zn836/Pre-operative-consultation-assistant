# 术前谈话助手 🏥

基于AI的视频智能问答系统,为患者提供术前准备指导和疑问解答。

## 项目简介

术前谈话助手是一个创新的医疗辅助工具,通过分析术前谈话视频的字幕内容,快速定位并回答患者关于手术准备的各类问题。系统采用两阶段智能问答机制:
- **快速定位**:自动找到视频中最相关的时间点
- **专家解答**:提供详细、专业且易懂的术前指导

## 核心功能

### 1. 视频智能问答
- 自动加载术前谈话视频及对应字幕
- 支持自然语言提问
- 智能匹配视频中的相关片段
- 精准定位到具体时间点

### 2. 两阶段回答机制

**第一阶段 - 内容定位**
- 分析整个视频字幕内容
- 识别与问题最相关的核心时间点
- 提供该时间点的简要内容描述
- 自动提前5秒缓冲时间,确保观看体验

**第二阶段 - 专家详解**
- 点击"获取专家详细解答"按钮
- 基于定位的内容提供深度分析
- 通俗易懂的语言解释医学概念
- 充满同理心的专业指导(控制在300字左右)

### 3. 智能推荐问题
- 自动分析视频内容
- 生成3-5个推荐问题
- 一键点击即可提问

### 4. 视频快速跳转
- 点击"播放"按钮直接跳转到相关时间点
- 无需手动拖动进度条
- 精准定位关键内容

## 技术架构

### 技术栈
- **前端框架**: Streamlit (Python Web应用框架)
- **AI模型**: GPT-OSS-120B (基于OpenAI兼容API)
- **后端**: Python 3.x
- **视频处理**: Streamlit原生视频播放器
- **字幕解析**: 自定义解析器,支持时间戳格式字幕

### 核心模块

#### app.py - 主应用程序
- 负责UI界面渲染和交互
- 视频播放控制
- 字幕解析和时间戳匹配
- API调用和状态管理

#### prompts.py - 提示词配置
- `SYSTEM_PROMPT`: 主问答系统提示词(两阶段分析)
- `ANSWER_PROMPT`: 专家详细解答提示词
- `SUGGESTED_QUESTIONS_PROMPT_TEMPLATE`: 推荐问题生成模板

### 数据流程

```
用户提问 → 字幕文本分析 → 时间点定位 → 内容概要
                                          ↓
                            用户选择 → 专家详细解答
                                          ↓
                                    视频跳转/文字展示
```

## 项目结构

```
video_qa_assistant/
├── app.py                 # 主应用程序
├── prompts.py            # AI提示词配置文件
├── .env                  # 环境变量配置(需手动创建)
├── video/                # 视频资源文件夹
│   ├── 1.mp4            # 视频文件
│   └── 1.txt            # 对应字幕文件
└── __pycache__/         # Python缓存文件夹
```

## 快速开始

### 环境要求
- Python 3.8+
- 稳定的网络连接(用于调用API)

### 安装步骤

1. **克隆或下载项目**
```bash
cd video_qa_assistant
```

2. **安装依赖**
```bash
pip install streamlit requests python-dotenv
```

3. **配置环境变量**

创建 `.env` 文件(可选,当前配置已硬编码在代码中):
```env
API_BASE_URL=http://58.34.97.143:4000/v1/chat/completions
API_KEY=sk-9jWCuocCFjkCRWVvdtwG
MODEL_NAME=openai/gpt-oss-120b
```

4. **准备视频和字幕**

在 `video/` 文件夹中放入:
- 视频文件 (支持 .mp4, .avi, .mov)
- 对应的字幕文件 (同名 .txt 文件)

字幕文件格式示例:
```
[00:00:00.620 - 00:00:12.300] 各位患者和家属大家好,我是心内科的XXX医生
[00:00:12.300 - 00:00:25.500] 今天我们来讲一下术前需要做哪些准备
```

5. **启动应用**
```bash
streamlit run app.py
```

6. **访问应用**

浏览器会自动打开 `http://localhost:8501`

## 使用指南

### 基本操作流程

1. **观看视频**
   - 系统自动加载 `video` 文件夹中的第一个视频
   - 视频会自动显示在页面顶部

2. **提出问题**
   - 在问题输入框中输入您的疑问
   - 例如: "术前需要做哪些准备?"
   - 点击"🔍 提问"按钮

3. **查看回答**
   - 系统会自动定位到最相关的视频时间点
   - 显示该时间点的内容概要

4. **获取详细解答**
   - 点击"👨‍⚕️ 获取专家详细解答"按钮
   - 系统会基于定位内容提供300字左右的详细专业指导

5. **跳转视频**
   - 点击"📍播放"按钮
   - 视频会自动跳转到相关时间点

6. **使用推荐问题**
   - 页面底部显示3-5个推荐问题
   - 点击任意问题即可快速提问

### 常见使用场景

#### 场景1: 了解术前准备事项
**问题示例**:
- "术前需要准备什么?"
- "手术前要做哪些检查?"
- "术前饮食有什么要求?"

#### 场景2: 药物相关咨询
**问题示例**:
- "术前需要停用哪些药物?"
- "抗凝药物怎么调整?"
- "常规用药需要调整吗?"

#### 场景3: 手术风险了解
**问题示例**:
- "手术有哪些风险?"
- "术后可能出现什么并发症?"
- "如何降低手术风险?"

#### 场景4: 术后恢复相关
**问题示例**:
- "术后需要注意什么?"
- "恢复期大概多长时间?"
- "术后饮食有什么要求?"

### 功能说明

#### 智能时间点定位
- 系统不是简单关键词匹配,而是理解问题核心含义
- 自动提前5秒缓冲,确保完整观看相关内容
- 只返回最相关的核心时间点,避免信息过载

#### 两阶段回答设计
**为什么采用两阶段?**
- **第一阶段**快速定位,让用户快速了解视频中是否有答案
- **第二阶段**深度解读,提供更专业、更详细的指导
- 用户可以根据需求选择是否获取详细解答,节省时间

#### 专家解答特点
- **字数精简**: 控制在300字左右,简洁明了
- **通俗易懂**: 避免过多医学术语
- **结构清晰**: 2-3个要点,便于理解和记忆
- **富有同理心**: 理解患者焦虑,给予心理支持
- **实用可操作**: 具体建议而非空泛理论

## API配置说明

### 当前配置
- **API地址**: `http://58.34.97.143:4000/v1/chat/completions`
- **模型**: `openai/gpt-oss-120b`
- **认证**: Bearer Token认证

### 修改API配置

在 [app.py](app.py) 的第13-15行:
```python
API_BASE_URL = "http://58.34.97.143:4000/v1/chat/completions"
API_KEY = "sk-9jWCuocCFjkCRWVvdtwG"
MODEL_NAME = "openai/gpt-oss-120b"
```

或者使用 `.env` 文件配置(需修改代码读取环境变量)

### API参数说明

**问答API调用**:
- `max_tokens`: 1500 (第一阶段内容定位)
- `temperature`: 0.7 (平衡创造性和准确性)
- `top_p`: 0.8

**专家解答API调用**:
- `max_tokens`: 2000 (专家详细解答)
- `temperature`: 0.7
- `top_p`: 0.8

## 字幕文件格式要求

### 标准格式
```
[HH:MM:SS.mmm - HH:MM:SS.mmm] 字幕文本内容
```

### 示例
```
[00:00:00.620 - 00:00:12.300] 各位患者和家属大家好,我是心内科的XXX医生
[00:00:12.300 - 00:00:25.500] 今天我们来讲一下术前需要做哪些准备
[00:00:25.500 - 00:00:40.200] 首先第一点,术前需要完善相关检查
```

### 注意事项
- 时间格式必须严格遵循 `HH:MM:SS.mmm` 格式
- 使用方括号 `[]` 包围时间戳
- 时间戳之间使用 `-` 分隔
- 字幕文件必须与视频文件同名(仅扩展名不同)

## 自定义配置

### 修改提示词

编辑 [prompts.py](prompts.py) 文件:

1. **修改问答系统提示词** (`SYSTEM_PROMPT`)
   - 调整时间点定位策略
   - 修改回答格式要求

2. **修改专家解答提示词** (`ANSWER_PROMPT`)
   - 调整回答风格和语气
   - 修改字数限制
   - 调整回答结构

3. **修改推荐问题生成** (`SUGGESTED_QUESTIONS_PROMPT_TEMPLATE`)
   - 调整推荐问题的方向
   - 修改问题数量

### 修改UI样式

编辑 [app.py](app.py) 的CSS样式部分(第25-64行):
```python
st.markdown("""
<style>
    .main-title { ... }
    .answer-box { ... }
    .recommended-questions { ... }
</style>
""", unsafe_allow_html=True)
```

### 调整字幕上下文范围

在 [app.py](app.py) 的第129行修改 `context_range` 参数:
```python
def get_relevant_subtitle_content(subtitles, timestamp, context_range=3):
```
- 默认值 `3` 表示获取目标时间点前后各3条字幕
- 增大该值可获取更多上下文,但可能增加无关信息

## 常见问题

### Q1: 为什么找不到相关时间点?
**可能原因**:
- 视频字幕中确实没有相关内容
- 问题表述与视频内容差异较大
- 字幕文件格式不正确

**解决方法**:
- 尝试换一种方式提问
- 查看推荐问题,了解视频主要内容
- 检查字幕文件格式是否正确

### Q2: API调用失败怎么办?
**可能原因**:
- 网络连接问题
- API服务不可用
- API密钥失效

**解决方法**:
- 检查网络连接
- 查看控制台错误信息
- 确认API配置是否正确

### Q3: 视频无法播放?
**可能原因**:
- 视频格式不支持
- 文件路径错误
- 浏览器兼容性问题

**解决方法**:
- 确保视频格式为 mp4/avi/mov
- 检查文件是否在 `video/` 文件夹中
- 尝试使用Chrome或Edge浏览器

### Q4: 字幕文件无法识别?
**可能原因**:
- 字幕文件命名与视频不一致
- 字幕格式不正确
- 文件编码问题

**解决方法**:
- 确保字幕文件与视频同名(仅扩展名不同)
- 检查字幕格式是否符合要求
- 确保文件编码为UTF-8

### Q5: 专家解答按钮不显示?
**可能原因**:
- 第一阶段未找到相关时间点
- 系统状态未正确更新

**解决方法**:
- 只有找到相关时间点后才会显示按钮
- 尝试重新提问

## 最佳实践

### 1. 问题表述建议
- **具体明确**: "术前需要停用哪些药物?" 优于 "药物怎么办?"
- **一次一问**: 避免在一个问题中包含多个子问题
- **使用医学术语**: 如"抗凝药物"比"血液稀释的药"更准确

### 2. 视频内容准备
- **清晰完整**: 确保术前谈话视频内容完整
- **音频清晰**: 影响字幕准确性
- **结构化讲解**: 分点说明更便于系统定位

### 3. 字幕质量要求
- **准确性**: 字幕内容应准确反映音频
- **完整性**: 不要遗漏重要信息
- **时间同步**: 时间戳应与视频精确对应

### 4. 使用技巧
- **先看推荐问题**: 了解视频主要内容
- **循序渐进**: 从总体到细节逐步深入
- **结合视频**: 看完相关片段后再提问
- **合理使用专家解答**: 对复杂问题使用专家详细解答

## 注意事项

### 医疗安全提醒
⚠️ **重要声明**:
- 本系统仅供术前知识普及和辅助说明使用
- 不能替代医生的专业诊断和建议
- 涉及用药、手术决策等重要事项,必须咨询主治医生
- 系统回答基于视频内容,可能不完全适用于个体情况

### 隐私和数据安全
- 确保视频内容不包含患者隐私信息
- API调用会将问题和字幕发送到外部服务器
- 建议在内网环境或使用私有API部署

### 性能考虑
- API调用需要网络延迟(通常2-10秒)
- 视频文件较大时加载可能较慢
- 建议视频时长控制在30分钟以内

## 技术支持

### 项目依赖
```
streamlit>=1.28.0
requests>=2.31.0
python-dotenv>=1.0.0
```

### 兼容性
- **Python版本**: 3.8+
- **浏览器**: Chrome 90+, Edge 90+, Firefox 88+
- **操作系统**: Windows, macOS, Linux

### 开发和贡献
如需定制开发或功能增强,可以:
1. 修改提示词以适应不同医学场景
2. 扩展支持多个视频
3. 添加视频上传功能
4. 集成语音识别自动生成字幕
5. 添加用户历史记录功能

## 更新日志

### 当前版本特性
- ✅ 视频自动加载和播放
- ✅ 智能问答和时间点定位
- ✅ 两阶段回答机制
- ✅ 专家详细解答(300字精简版)
- ✅ 推荐问题生成
- ✅ 视频快速跳转
- ✅ 响应式UI设计

### 未来计划
- 🔜 支持多视频管理
- 🔜 添加对话历史记录
- 🔜 支持视频上传和字幕自动生成
- 🔜 添加导出功能(PDF/Word)
- 🔜 多语言支持

## 许可协议

本项目仅供学习和研究使用,禁止商业用途。

---

**项目信息**
- **名称**: 术前谈话助手
- **版本**: 1.0.0
- **技术栈**: Streamlit + GPT-OSS-120B
- **适用场景**: 心内科术前谈话辅助
- **开发语言**: Python 3.x

💡 如有问题或建议,欢迎反馈!
